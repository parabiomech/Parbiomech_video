<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parbiomech Video Analysis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .upload-section {
            background: #f8f9fa;
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-section:hover {
            background: #e9ecef;
            border-color: #764ba2;
        }

        .upload-section.active {
            background: #d4edda;
            border-color: #28a745;
        }

        .video-container {
            display: none;
            margin-bottom: 30px;
        }

        .video-container.active {
            display: block;
        }

        video {
            width: 100%;
            max-height: 500px;
            border-radius: 10px;
            background: black;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .timepoints-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 100px;
        }

        .timepoint-tag {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            margin: 5px;
            font-size: 14px;
        }

        .results-section {
            display: none;
            margin-top: 30px;
        }

        .results-section.active {
            display: block;
        }

        .result-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .result-image {
            width: 100%;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .angles-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .angles-table th,
        .angles-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .angles-table th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        .angles-table tr:hover {
            background: #f8f9fa;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }

        .progress-bar.active {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading-spinner.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        canvas {
            display: none;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ Parbiomech Video Analysis</h1>
            <p>MediaPipe ê¸°ë°˜ ì›¹ í¬ì¦ˆ ë¶„ì„ ì‹œìŠ¤í…œ</p>
        </div>

        <div class="main-content">
            <!-- ì—…ë¡œë“œ ì„¹ì…˜ -->
            <div class="upload-section" id="uploadSection">
                <h2>ğŸ“‚ ë¹„ë””ì˜¤ íŒŒì¼ ì„ íƒ</h2>
                <p style="margin: 15px 0;">MP4, AVI, MOV, WebM í˜•ì‹ ì§€ì›</p>
                <input type="file" id="videoInput" accept="video/*" style="display: none;">
                <button class="btn btn-primary" onclick="document.getElementById('videoInput').click()">
                    ğŸ“ íŒŒì¼ ì„ íƒ
                </button>
                <p style="margin-top: 15px; color: #6c757d; font-size: 14px;">
                    ë˜ëŠ” íŒŒì¼ì„ ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”
                </p>
            </div>

            <!-- ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ -->
            <div class="video-container" id="videoContainer">
                <video id="videoPlayer" controls></video>
                
                <div class="controls">
                    <button class="btn btn-success" id="tagBtn" onclick="tagCurrentTime()">
                        ğŸ·ï¸ í˜„ì¬ ì‹œì  íƒœê·¸ (Space)
                    </button>
                    <button class="btn btn-danger" id="clearBtn" onclick="clearAllTimepoints()">
                        ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ
                    </button>
                    <button class="btn btn-primary" id="analyzeBtn" onclick="startAnalysis()">
                        ğŸ” ë¶„ì„ ì‹œì‘
                    </button>
                </div>

                <div class="timepoints-list" id="timepointsList">
                    <h3>íƒœê·¸ëœ ì‹œì  (0ê°œ)</h3>
                    <div id="timepointsContainer"></div>
                </div>
            </div>

            <!-- ì§„í–‰ë¥  í‘œì‹œ -->
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>

            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner"></div>
                <p style="margin-top: 15px;">ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>

            <!-- ê²°ê³¼ ì„¹ì…˜ -->
            <div class="results-section" id="resultsSection">
                <h2>ğŸ“Š ë¶„ì„ ê²°ê³¼</h2>
                <div id="resultsContainer"></div>
            </div>
        </div>
    </div>

    <!-- MediaPipe ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>

    <script>
        let videoElement = document.getElementById('videoPlayer');
        let timepoints = [];
        let pose = null;
        let canvas = document.createElement('canvas');
        let ctx = canvas.getContext('2d');

        // MediaPipe Pose ì´ˆê¸°í™”
        function initPose() {
            pose = new Pose({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
                }
            });

            pose.setOptions({
                modelComplexity: 1,
                smoothLandmarks: true,
                enableSegmentation: false,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
        }

        // íŒŒì¼ ì„ íƒ ì²˜ë¦¬
        document.getElementById('videoInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                videoElement.src = url;
                document.getElementById('videoContainer').classList.add('active');
                document.getElementById('uploadSection').classList.add('active');
                timepoints = [];
                updateTimepointsList();
                
                if (!pose) {
                    initPose();
                }
            }
        });

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        const uploadSection = document.getElementById('uploadSection');
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.style.background = '#e9ecef';
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.style.background = '#f8f9fa';
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.style.background = '#f8f9fa';
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('video/')) {
                const url = URL.createObjectURL(file);
                videoElement.src = url;
                document.getElementById('videoContainer').classList.add('active');
                document.getElementById('uploadSection').classList.add('active');
                timepoints = [];
                updateTimepointsList();
                
                if (!pose) {
                    initPose();
                }
            }
        });

        // í˜„ì¬ ì‹œì  íƒœê·¸
        function tagCurrentTime() {
            const currentTime = videoElement.currentTime;
            if (!timepoints.includes(currentTime)) {
                timepoints.push(currentTime);
                timepoints.sort((a, b) => a - b);
                updateTimepointsList();
                
                showNotification('success', `âœ“ ${currentTime.toFixed(2)}ì´ˆ ì‹œì ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } else {
                showNotification('warning', 'ì´ë¯¸ ì¶”ê°€ëœ ì‹œì ì…ë‹ˆë‹¤.');
            }
        }

        // ì‹œì  ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateTimepointsList() {
            const listTitle = document.querySelector('#timepointsList h3');
            const container = document.getElementById('timepointsContainer');
            
            listTitle.textContent = `íƒœê·¸ëœ ì‹œì  (${timepoints.length}ê°œ)`;
            
            if (timepoints.length === 0) {
                container.innerHTML = '<p style="color: #6c757d;">ì¶”ê°€ëœ ì‹œì ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                container.innerHTML = timepoints.map(t => 
                    `<span class="timepoint-tag">${t.toFixed(2)}ì´ˆ</span>`
                ).join('');
            }
        }

        // ì „ì²´ ì‚­ì œ
        function clearAllTimepoints() {
            if (timepoints.length > 0 && confirm('ëª¨ë“  ì‹œì ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                timepoints = [];
                updateTimepointsList();
                showNotification('info', 'ëª¨ë“  ì‹œì ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ê°ë„ ê³„ì‚° í•¨ìˆ˜ë“¤
        function calculateSegmentAngle(point1, point2) {
            const radians = Math.atan2(point2.y - point1.y, point2.x - point1.x);
            let angle = radians * (180 / Math.PI);
            if (angle < 0) angle += 360;
            return angle;
        }

        function calculateJointAngle(a, b, c) {
            const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * (180 / Math.PI));
            if (angle > 180) angle = 360 - angle;
            return angle;
        }

        function calculateAngles(landmarks) {
            const angles = { absolute: {}, relative: {} };
            
            // ì ˆëŒ€ê°ë„
            if (landmarks[11] && landmarks[13]) {
                angles.absolute['ì¢Œ_ìƒì™„'] = calculateSegmentAngle(landmarks[11], landmarks[13]);
            }
            if (landmarks[12] && landmarks[14]) {
                angles.absolute['ìš°_ìƒì™„'] = calculateSegmentAngle(landmarks[12], landmarks[14]);
            }
            if (landmarks[23] && landmarks[25]) {
                angles.absolute['ì¢Œ_ëŒ€í‡´'] = calculateSegmentAngle(landmarks[23], landmarks[25]);
            }
            if (landmarks[24] && landmarks[26]) {
                angles.absolute['ìš°_ëŒ€í‡´'] = calculateSegmentAngle(landmarks[24], landmarks[26]);
            }
            if (landmarks[25] && landmarks[27]) {
                angles.absolute['ì¢Œ_í•˜í‡´'] = calculateSegmentAngle(landmarks[25], landmarks[27]);
            }
            if (landmarks[26] && landmarks[28]) {
                angles.absolute['ìš°_í•˜í‡´'] = calculateSegmentAngle(landmarks[26], landmarks[28]);
            }
            
            // ìƒëŒ€ê°ë„
            if (landmarks[11] && landmarks[13] && landmarks[15]) {
                angles.relative['ì¢Œ_íŒ”ê¿ˆì¹˜'] = calculateJointAngle(landmarks[11], landmarks[13], landmarks[15]);
            }
            if (landmarks[12] && landmarks[14] && landmarks[16]) {
                angles.relative['ìš°_íŒ”ê¿ˆì¹˜'] = calculateJointAngle(landmarks[12], landmarks[14], landmarks[16]);
            }
            if (landmarks[23] && landmarks[25] && landmarks[27]) {
                angles.relative['ì¢Œ_ë¬´ë¦'] = calculateJointAngle(landmarks[23], landmarks[25], landmarks[27]);
            }
            if (landmarks[24] && landmarks[26] && landmarks[28]) {
                angles.relative['ìš°_ë¬´ë¦'] = calculateJointAngle(landmarks[24], landmarks[26], landmarks[28]);
            }
            if (landmarks[11] && landmarks[23] && landmarks[25]) {
                angles.relative['ì¢Œ_ì—‰ë©ì´'] = calculateJointAngle(landmarks[11], landmarks[23], landmarks[25]);
            }
            if (landmarks[12] && landmarks[24] && landmarks[26]) {
                angles.relative['ìš°_ì—‰ë©ì´'] = calculateJointAngle(landmarks[12], landmarks[24], landmarks[26]);
            }
            
            return angles;
        }

        // ë¶„ì„ ì‹œì‘
        async function startAnalysis() {
            if (timepoints.length === 0) {
                showNotification('warning', 'ë¶„ì„í•  ì‹œì ì„ ë¨¼ì € ì¶”ê°€í•˜ì„¸ìš”.');
                return;
            }

            document.getElementById('progressBar').classList.add('active');
            document.getElementById('loadingSpinner').classList.add('active');
            document.getElementById('analyzeBtn').disabled = true;

            const results = [];

            for (let i = 0; i < timepoints.length; i++) {
                const time = timepoints[i];
                updateProgress((i + 1) / timepoints.length * 100, `ì‹œì  ${i + 1}/${timepoints.length} ë¶„ì„ ì¤‘...`);
                
                const result = await analyzeFrame(time);
                results.push(result);
                
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            displayResults(results);
            
            document.getElementById('progressBar').classList.remove('active');
            document.getElementById('loadingSpinner').classList.remove('active');
            document.getElementById('analyzeBtn').disabled = false;
            
            showNotification('success', 'âœ… ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // í”„ë ˆì„ ë¶„ì„
        async function analyzeFrame(time) {
            return new Promise((resolve) => {
                videoElement.currentTime = time;
                
                videoElement.onseeked = async () => {
                    canvas.width = videoElement.videoWidth;
                    canvas.height = videoElement.videoHeight;
                    ctx.drawImage(videoElement, 0, 0);
                    
                    pose.onResults((results) => {
                        // í¬ì¦ˆ ê·¸ë¦¬ê¸°
                        ctx.drawImage(videoElement, 0, 0);
                        
                        if (results.poseLandmarks) {
                            drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
                            drawLandmarks(ctx, results.poseLandmarks, {color: '#FF0000', lineWidth: 2, radius: 6});
                            
                            const angles = calculateAngles(results.poseLandmarks);
                            const imageUrl = canvas.toDataURL();
                            
                            resolve({
                                time: time,
                                image: imageUrl,
                                angles: angles,
                                detected: true
                            });
                        } else {
                            const imageUrl = canvas.toDataURL();
                            resolve({
                                time: time,
                                image: imageUrl,
                                angles: null,
                                detected: false
                            });
                        }
                    });
                    
                    await pose.send({image: canvas});
                };
            });
        }

        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateProgress(percent, message) {
            const fill = document.getElementById('progressFill');
            fill.style.width = percent + '%';
            fill.textContent = Math.round(percent) + '% - ' + message;
        }

        // ê²°ê³¼ í‘œì‹œ
        function displayResults(results) {
            const container = document.getElementById('resultsContainer');
            const section = document.getElementById('resultsSection');
            
            container.innerHTML = '';
            
            results.forEach((result, index) => {
                const card = document.createElement('div');
                card.className = 'result-card';
                
                let html = `
                    <h3>ì‹œì  ${index + 1}: ${result.time.toFixed(2)}ì´ˆ</h3>
                    <img src="${result.image}" class="result-image" alt="ë¶„ì„ ê²°ê³¼">
                `;
                
                if (result.detected && result.angles) {
                    html += `
                        <table class="angles-table">
                            <tr><th>í•­ëª©</th><th>ê°ë„ (Â°)</th></tr>
                    `;
                    
                    for (let [name, value] of Object.entries(result.angles.absolute)) {
                        html += `<tr><td>ì ˆëŒ€_${name}</td><td>${value.toFixed(2)}</td></tr>`;
                    }
                    for (let [name, value] of Object.entries(result.angles.relative)) {
                        html += `<tr><td>ê´€ì ˆ_${name}</td><td>${value.toFixed(2)}</td></tr>`;
                    }
                    
                    html += `</table>`;
                } else {
                    html += `<p style="color: #dc3545;">âš ï¸ í¬ì¦ˆë¥¼ ê°ì§€í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
                }
                
                card.innerHTML = html;
                container.appendChild(card);
            });
            
            section.classList.add('active');
            section.scrollIntoView({ behavior: 'smooth' });
        }

        // ì•Œë¦¼ í‘œì‹œ
        function showNotification(type, message) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} notification`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ (Space: ì‹œì  íƒœê·¸)
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && videoElement.src && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                tagCurrentTime();
            }
        });
    </script>
</body>
</html>
